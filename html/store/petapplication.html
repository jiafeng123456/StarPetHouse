<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>店铺申请</title>
  <link rel="stylesheet" type="text/css" href="../../static/css/global.css">
  <link rel="stylesheet" type="text/css" href="../../layui-v2.5.6/css/layui.css">
  <script type="text/javascript" src="../../layui-v2.5.6/layui.js"></script>
  <script src="../../static/js/index/index.js" type="text/javascript"></script>
  <script src="../../static/js/index/freezeheader.js" type="text/javascript"></script>
  <script src="../../static/layui-v2.5.6/lay/modules/layer.js" type="text/javascript"></script>
  <script src="../../static/js/index/sliders.js" type="text/javascript"></script>
  <script src="../../static/js/index/html5.js" type="text/javascript"></script>
  <script src="../../static/js/index/article.js" type="text/javascript"></script>
  <script src="../../static/js/lib/jquery.js"></script>
  <script src="../../static/js/lib/jquery-ui.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
</head>
<body>
<div class="layui-header header">
  <div class="layui-form">
    <div class="main">
      <script id="demo" type="text/html">
        <ul class="layui-nav layui-nav-left" lay-filter="filter">
              {{#  layui.each(d.list, function(index, item){ }}
              <li class="layui-nav-item">
                <a href="{{ item.url }}"  target="content">{{ item.name }}</a>
              </li>
              <!-- <a href="{{ item.url }}" target="content">{{ item.name }}</a> -->
              {{#  }); }}
              {{#  if(d.list.length === 0){ }}
              无数据
              {{#  } }}
        </ul>
      </script>
      <div id="view" class="main"></div>
        <ul class="layui-nav layui-layout-right layui-nav-right" lay-filter="filter">
            <li class="layui-nav-item">
                <a href="home.html" target="content">我的主页<span class="layui-badge-dot"></span></a>
            </li>
            <li class="layui-nav-item">
                <a href="javascript:;"><img src="" id="headImage" class="layui-nav-img">我</a><span class="layui-nav-more"></span>
                <dl class="layui-nav-child">
                    <dd><a href="javascript:;" id="modifInfo">修改信息</a></dd>
                    <dd><a href="javascript:;" id="logOut">退了</a></dd>
                </dl>
            </li>
        </ul>
      
    </div>
  </div>
</div>
<div style="height: 30px;">
  
</div>
<div class="content">
  <div>
    <div class="layui-row layui-col-space10">
    <div class="layui-col-md1">
      你的内容 1/12
    </div>
    <div class="layui-col-md7">
    <script id="demo1" type="text/html">
    <form class="layui-form" action="">
      <input type="text" hidden name="user_id" value="{{ d.list.user_id }}">
      <input type="text" hidden name="op_type" value="{{ d.op_type }}">
      <!-- <input type="text" hidden name="store_id" value="{{ d.list.store_id }}"> -->
      <div class="layui-form-item">
        <label class="layui-form-label">店铺名称</label>
        <div class="layui-input-block">
            <input type="text" name="store_name" lay-verify="required" lay-reqtext="店铺名称是必填项，岂能为空？" placeholder="请输入" autocomplete="off" class="layui-input" value="{{ d.list.store_name || '' }}">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">店铺头像</label>
        <div class="layui-input-block">
            <img class="layui-upload-img" width="100px" height="100px" style="border-radius: 50px" id="img2" src="{{ d.list.store_image_url || '' }}">
            <input type="hidden" name="store_image_url" class="image">
            <div class="layui-upload">
              <button type="button" class="layui-btn" id="test1">上传图片</button>
            </div>
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">营业许可证</label>
        <div class="layui-input-block">
            <img class="layui-upload-img" width="100px" height="100px" style="border-radius: 50px" id="img3" src="{{ d.list.application_image || '' }}">
            <input type="hidden" name="application_image" class="image3">
            <div class="layui-upload">
              <button type="button" class="layui-btn" id="test3">上传图片</button>
            </div>
        </div>
      </div>
    <div class="layui-form-item">
        <label class="layui-form-label">店铺介绍</label>
        <div class="layui-input-block">
            <input type="text" name="store_description" lay-verify="required" lay-reqtext="用户名是必填项，岂能为空？" placeholder="请输入" autocomplete="off" class="layui-input" value="{{ d.list.store_description || ''}}">
        </div>
    </div>
    <div class="layui-form-item">
      <label class="layui-form-label">地址</label>
      <div class="layui-input-inline">
        <select id="province" lay-filter="province" name="province_no" lay-verify="required" lay-search="">
          <option value="{{ d.list.province_no || ''}}">{{ d.list.province_name || '请选择或搜索省'}}</option>
        </select>
      </div>
      <div class="layui-input-inline">
        <select id="city" lay-filter="city" lay-verify="required" name="city_no" lay-search="">
          <option value="{{ d.list.city_no || ''}}">{{ d.list.city_name || '请选择或搜索市'}}</option>
        </select>
      </div>
      <div class="layui-input-inline">
        <select id="area" lay-filter="area" lay-verify="required" name="district_no" lay-search="">
          <option value="{{ d.list.district_no || ''}}">{{ d.list.district_name || '请选择或搜索县/区'}}</option>          
        </select>
      </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">详细地址</label>
        <div class="layui-input-block">
          <input class="layui-input" id="" lay-verify="required" name="address" value="{{ d.list.address || ''}}" placeholder="城镇＋乡村＋街道＋门牌号码"></input>
        </div>
    </div>
   <div class="layui-form-item">
    <div class="layui-input-block">
      <button type="submit" class="layui-btn" lay-submit="" lay-filter="demo1">立即提交</button>
      <button type="reset" class="layui-btn layui-btn-primary">重置</button>
    </div>
  </div>
</form>
</script>
<div id="view1" class="main"></div>
    </div>
    <div class="layui-col-md3 ">
      你的内容 2/12
    </div>
    <div class="layui-col-md1">
      你的内容 1/12
    </div>
  </div>
  </div>
  
</div>

<script>
  
  layui.use(['layer','laytpl','jquery','form','layedit', 'laydate','upload'], function(){
      var $ = layui.jquery;
      var laytpl = layui.laytpl;
      var form = layui.form,layedit = layui.layedit
            ,laydate = layui.laydate,upload = layui.upload;;
      var username = getUrlParam("username");
      var op_type = getUrlParam("op_type");
      debugger
      $.ajax({
          type: 'POST',
          data:{username:username},
          url: 'http://127.0.0.1:8088/user/getUserMenu',
          success: function (data) {
            if (data.error_no == "0") {
                var getTpl = demo.innerHTML,
                view = document.getElementById("view");
                laytpl(getTpl).render(data, function(html) {
                  view.innerHTML = html;
                });
                $("#headImage").attr("src",data.image);
                $("#modifInfo").attr("href","../person/modifUserInfo.html?username=" + username);
                $("#logOut").attr("href","../login.html");
                
              }
              
          },
          error:function(){
            url = "../login.html";
            window.location.href = url; 
          }

      });

      $.ajax({
          type: 'POST',
          data:{user_name:username,op_type:op_type},
          url: 'http://127.0.0.1:8088/store/getStoreInfo',
          success: function (data) {
            if (data.error_no == "0") {
              debugger;
                var getTpl = demo1.innerHTML,
                view1 = document.getElementById("view1");
                laytpl(getTpl).render(data, function(html) {
                  view1.innerHTML = html;
                });
                layui.use('form', function() {
                var form = layui.form; //++只有执行了这一步，部分表单元素才会自动修饰成功
                form.render();
                });
                //普通图片上传
                var uploadInst = upload.render({
                elem: '#test1'
                ,accept:"images"
                ,auto : "true"
                ,url: 'http://127.0.0.1:8088/upload/uploadImage' //改成您自己的上传接口
                ,choose: function(obj){
                //预读本地文件示例，不支持ie8
                obj.preview(function(index, file, result){
                $('#demo1').attr('src', result); //图片链接（base64）
                });
                }
                ,done: function(res){
                //如果上传失败
                if(res.code > 0){
                  return layer.msg('上传失败');
                }
                var fileupload = $(".image");
                fileupload.attr("value",res.data.src);
                var fileupload1 = $("#img2");
                fileupload1.attr("src",res.data.src);
                console.log(fileupload.attr("value"));
                }
                ,error: function(){
    
                }
              });
                //普通图片上传
                var uploadInst1 = upload.render({
                elem: '#test3'
                ,accept:"images"
                ,auto : "true"
                ,url: 'http://127.0.0.1:8088/upload/uploadImage' //改成您自己的上传接口
                ,choose: function(obj){
                //预读本地文件示例，不支持ie8
                obj.preview(function(index, file, result){
                $('#demo1').attr('src', result); //图片链接（base64）
                });
                }
                ,done: function(res){
                //如果上传失败
                if(res.code > 0){
                  return layer.msg('上传失败');
                }
                var fileupload = $(".image3");
                fileupload.attr("value",res.data.src);
                var fileupload1 = $("#img3");
                fileupload1.attr("src",res.data.src);
                console.log(fileupload.attr("value"));
                }
                ,error: function(){
    
                }
              });

                layui.use(['form','layer','jquery'],function(){
  var form = layui.form,
   layer = parent.layer === undefined ? layui.layer : parent.layer,
   $ = layui.jquery;
  var provinceText = "";
  var cityText = "";
  var areaText = "";
  //异步加载下拉框数据
  $.post("http://127.0.0.1:8088/address/queryByParentId",{"id":0},function (data) {
    debugger
    if(!data.success){
      layer.msg(data.msg)
    }else{
      var $html = "";
      if(data.allCityCodeList != null) {
        $.each(data.allCityCodeList, function (index, item) {
          $html += "<option value='" + item.province_no + "'>" + item.province_name + "</option>";
        });
        $("#province").append($html);
        //append后必须从新渲染
        form.render('select');
      }
    }
  
  });
  
  //监听省下拉框
  form.on('select(province)', function(dataObj){
    //移除城市下拉框所有选项
    $("#city").empty();
    var cityHtml = '<option value="">请选择或搜索市</option>';
    $("#city").html(cityHtml);
    var areaHtml = '<option value="">请选择或搜索县/区</option>';
    $("#area").html(areaHtml);
    provinceText = $("#province").find("option:selected").text();
    var value = $("#province").val();
    //异步加载下拉框数据
    $.post("http://127.0.0.1:8088/address/queryCityByParentId",{"province_no":value},function (data) {
      if(!data.success){
        layer.msg(data.msg)
      }else{
        var $html = "";
        if(data.allCityCodeList != null) {
          $.each(data.allCityCodeList, function (index, item) {
            $html += "<option value='" + item.city_no + "'>" + item.city_name + "</option>";
          });
          $("#city").append($html);
          //append后必须从新渲染
          form.render('select');
        }
      }
  
    });
  
  });
  
  //监听市下拉框
  form.on('select(city)', function(dataObj){
    //移除县区下拉框所有选项
    $("#area").empty();
    var html = '<option value="">请选择或搜索县/区</option>';
    $("#area").html(html);
  
    cityText = $("#city").find("option:selected").text();
    var value = $("#city").val();
    //异步加载下拉框数据
    $.post("http://127.0.0.1:8088/address/queryDistriceByParentId",{"city_no":value},function (data) {
      if(!data.success){
        layer.msg(data.msg)
      }else{
        var $html = "";
        if(data.allCityCodeList != null) {
          $.each(data.allCityCodeList, function (index, item) {
            $html += "<option value='" + item.district_no + "'>" + item.district_name + "</option>";
          });
          $("#area").append($html);
          //append后必须从新渲染
          form.render('select');
        }
      }
  
    });
  
  });
  
  //监听县区下拉框
  form.on('select(area)', function(dataObj){
    areaText = $("#area").find("option:selected").text();
  });
});
             }
              
          },
          error:function(){
            
          }

      });

        

           //监听提交
        form.on('submit(demo1)', function(data){

          $.ajax({
          type: 'POST',
          data:data.field,
          url: 'http://127.0.0.1:8088/store/saveStoreApplication',
          success: function (data) {
            if (data.error_no == "0") {
                layer.msg("申请成功");
                
              }else {
                layer.msg("申请失败：" + data.error_info);
              }
              
          },
          error:function(){
            
          }

          });
          return false;
        });



    function getUrlParam(name) {
      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
      var r = window.location.search.substr(1).match(reg); //匹配目标参数
      if (r != null) return unescape(r[2]); return null; //返回参数值
    }

  });
</script>


</body>
</html>s